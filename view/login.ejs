<%- include('layouts/header.ejs') %>
<div class="container-scroller">
  <div class="container-fluid page-body-wrapper full-page-wrapper">
    <div class="content-wrapper d-flex align-items-center auth">
      <div class="row flex-grow">
        <div class="col-lg-4 mx-auto d-flex align-items-center justify-content-between">
          <div class="auth-form-light text-left p-5"  id="loginnn">
            <div class="brand-logo">
              <img src="../../assets/images/logo.svg" />
            </div>
            <h6 class="font-weight-light">Sign in to continue.</h6>
            <form id="loginForm" class="pt-3">
              <div class="form-group">
                <input
                  type="email"
                  class="form-control form-control-lg"
                  id="InputEmail1"
                  placeholder="Username"
                  name="email"
                />
              </div>
              <div class="form-group">
                <input
                  type="password"
                  class="form-control form-control-lg"
                  id="InputPassword1"
                  placeholder="Password"
                  name="password"
                />
              </div>
              <div class="form-group">
                <label for="role">Role:</label>
                <select id="role" name="role" class="form-control" required>
                  <option value="admin">Admin</option>
                  <option value="vendor">Vendor</option>
                </select>
              </div>
              <div class="mt-3">
                <button
                  type="button"
                  class="btn btn-block btn-gradient-primary btn-lg font-weight-medium auth-form-btn"
                  onclick="signIn()"
                >
                  SIGN IN
                </button>
              </div>
              <div
                class="my-2 d-flex justify-content-between align-items-center"
              >
                <div class="form-check">
                  <label class="form-check-label text-muted">
                    <input type="checkbox" class="form-check-input" /> Keep me
                    signed in
                  </label>
                </div>
                <a href="#" class="auth-link text-black">Forgot password?</a>
              </div>

              <div class="text-center mt-4 font-weight-light">
                Don't have an account?
                <a href="/vendor-register" class="text-primary">Create</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- content-wrapper ends -->
  </div>
  <!-- page-body-wrapper ends -->
</div>



<script>
function signIn() {
  var formData = {
    email_id: document.getElementById("InputEmail1").value,
    password: document.getElementById("InputPassword1").value,
    role: document.getElementById("role").value,
  };
  console.log("Email:", formData.email_id);
  console.log("Password:", formData.password);
  console.log("Role:", formData.role);

  // You can call either signInAdmin or signInVendor based on the role
  if (formData.role === "admin") {
    signInAdmin(formData);
  } else if (formData.role === "vendor") {
    signInVendor(formData);
  }
}

function signInAdmin(formData) {

  console.log("admin============");
  fetch("http://localhost:3000/admin/login", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(formData),
  })
    .then((response) => {
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      return response.json();
    })
    .then((data) => {
      if (data.success) {
        if (formData.role === "admin" && data.role === "admin") {
          window.location.href = "adminDash";
        } else if (formData.role === "vendor" && data.role === "vendor") {
          window.location.href = data.redirectTo;
        } else {
          console.log("Role mismatch, handle accordingly");
          displayErrorMessage("Role mismatch. Please select the correct role.");
        }
        alert(data.message);
      } else {
        console.error("Authentication failed:", data.message);
        displayErrorMessage(data.message);
      }
    })
    .catch((error) => {
      console.error("Error during authentication:", error);
      displayErrorMessage(`An error occurred during authentication: ${error.message}`);
    });
}


function signInVendor(formData) {
  fetch("http://localhost:3000/vendor/login-vendor", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(formData),
  })
    .then((response) => response.json())
    .then((data) => {
      if (data.success) {
        if (formData.role === "vendor") {
          window.location.href = data.redirectTo;
        } else if (formData.role === "admin") {
          // Role mismatch for admin
          console.log("Role mismatch for admin, handle accordingly");
          displayErrorMessage("Role mismatch for admin. Please select the correct role.");
        }
        alert(data.message);
      } else {
        console.error("Authentication failed:", data.message);
        displayErrorMessage(data.message);
      }
    })
    .catch((error) => {
      console.error("Error:", error);
      displayErrorMessage("An error occurred during authentication. Please try again.");
    });
}

function displayErrorMessage(message) {
  // Display the error message on the screen
  var errorMessageElement = document.getElementById("errorMessage");

  if (!errorMessageElement) {
    errorMessageElement = document.createElement("div");
    errorMessageElement.id = "errorMessage";
    errorMessageElement.className = "alert alert-danger mt-3";
    document.getElementById("loginForm").appendChild(errorMessageElement);
  }

  errorMessageElement.textContent = message;
}

</script>

